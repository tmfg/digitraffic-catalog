{% extends 'package/new_package_form.html' %}

{% set field_groups = {
  "left-1": {
    "general": {
      "label": _("General"),
      "help_text": _("This section provides basic information about the dataset."),
      "fields": ["owner_org", "title_translated", "frequency", "spatial", "mobility_theme", "mobility_theme_sub", "theme", "notes_translated", "category", "transport_mode"],
      "subgroups": {
        "time_range": {
          "label": _("Temporal coverage"),
          "help_text": _("This section describes the temporal coverage of the dataset, if applicable. May be left empty for continuously updated data."),
          "fields": ["start_timestamp", "end_timestamp"],
          "module": "digitraffic_theme_temporal_coverage"
        }
      },
    }
  },
  "right-1": {
    "versioning" : {
      "label": _("Versioning"),
      "help_text": _("This section provides information regarding the dataset version. Mostly applicable for static datasets."),
      "fields": ["version", "version_notes_translated"]
    },
    "assessment": {
      "label": _("Assessment"),
      "help_text": _("This section describes the result and date of an assessment or assessments made by a third party or parties. The assessment of data sets under EU delegated regulations is usually carried out by a national supervisory authority."),
      "fields": ["assessment"]
    },
    "additional_information": {
      "label": _("Additional information"),
      "help_text": _("Additional details concerning the dataset."),
      "fields": ["language", "georeferencing_method", "network_coverage", "conforms_to", "intended_information_service", "quality_description", "related_resource"]
    },
  },
  "left-2": {
    "contact_point": {
      "label": _("Contact point"),
      "help_text": _("Contact details for a person or organization."),
      "fields": ["contact_point"]
    },
  },
  "right-2": {
    "rights_holder": {
      "label": _("Rights holder"),
      "help_text": _("Contact details for the rights holder."),
      "fields": ["rights_holder"]
    }
}
} %}

{% block stages %}
  {%- set pages = h.scheming_get_dataset_form_pages(dataset_type) -%}
  {%- if pages -%}
    {%- set active_page = data.get('_form_page', 1) | int -%}
    <ol class="stages stage-1">
      {%- for p in pages -%}
        <li class="{{
          'first ' if loop.first else ''}}{{
          'active ' if loop.index == active_page else '' }}"
          style="width:{{ 100 / (loop.length + (0 if form_style == 'edit' else 1)) }}%">
          <span class="highlight" style="padding-right:0">{% if loop.index < active_page
              or (form_style == 'edit' and loop.index != active_page)
            %}<a href="{{
              h.url_for(dataset_type +
                  ('.scheming_edit_page' if form_style == 'edit' else '.scheming_new_page'),
                package_type=dataset_type,
                id=data.name or data.id,
                page=loop.index)
            }}">{{ h.scheming_language_text(p.title) }}</a>{%
            else %}{{ h.scheming_language_text(p.title) }}{% endif %}
          </span>
        </li>
      {%- endfor -%}
      {%- if form_style != 'edit' -%}
        <li class="last {{ s2 }}" style="width:{{ 100 / (pages | length + 1) }}%">
          {% if s2 != 'complete' %}
            <span class="highlight">{{ _('Add data') }}</span>
          {% else %}
            {% if s1 == 'active' %}
              {# stage 1 #}
              <button class="highlight" name="save" value="go-resources" type="submit">{{ _('Add data') }}</button>
            {% else %}
              {% link_for _('Add data'), named_route='dataset.new', class_="highlight" %}
            {% endif %}
          {% endif %}
        </li>
      {%- endif -%}
    </ol>
  {%- else -%}
    {{ super() }}
  {%- endif -%}
{% endblock %}

{% block introduction %}
<p class="package-introduction">
  {%- trans -%}
  In CKAN, a dataset refers to a collection of resources (e.g., files)
  along with their descriptions and other metadata, such as a permanent
  URL.
  {%- endtrans -%}
</p>
{% endblock %}

{% block errors %}
  {%- if errors -%}
    {%- set schema = h.scheming_get_dataset_schema(dataset_type) -%}
    {%- snippet 'scheming/snippets/errors.html',
      errors=errors, fields=schema.dataset_fields,
      entity_type='dataset', object_type=dataset_type -%}
  {%- endif -%}
{% endblock %}

{% block basic_fields %}
  {%- if not dataset_type -%}
    <p>
    dataset_type not passed to template. your version of CKAN
    might not be compatible with ckanext-scheming
    </p>
  {%- endif -%}

  {%- set schema = h.scheming_get_dataset_schema(dataset_type) -%}
  {%- set pages = h.scheming_get_dataset_form_pages(dataset_type) -%}
  {%- if pages -%}
    {%- set active_page = data.get('_form_page', 1) | int -%}
    {%- set fields = pages[active_page - 1]['fields'] -%}
  {%- else -%}
    {%- set fields = schema.dataset_fields -%}
  {%- endif -%}

  <!-- render field groups -->
  {% snippet 'package/snippets/field_groups.html',
    field_groups=field_groups,
    schema_fields=schema.dataset_fields,
    data=data,
    errors=errors,
    dataset_type=dataset_type
  -%}

  {%- if pages -%}
    <input type="hidden" name="_ckan_phase" value="{{ active_page }}" />
  {%- elif 'resource_fields' not in schema -%}
    <!-- force controller to skip resource-editing step for this type -->
    <input type="hidden" name="_ckan_phase" value="" />
  {%- endif -%}

{% endblock %}

{% block metadata_fields %}
{% endblock %}

{% block save_button_text %}
  {%- set pages = h.scheming_get_dataset_form_pages(dataset_type) -%}
  {%- if pages and form_style == 'edit' -%}
    {%- set active_page = data.get('_form_page', 1) | int -%}
    {{ _('Update {page}').format(page=h.scheming_language_text(pages[active_page-1].title)) }}
  {%- elif pages -%}
    {{ _('Next') }}
  {%- else -%}
    {{ super() }}
  {%- endif -%}
{% endblock %}
