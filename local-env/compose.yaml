services:
  ckan:
    image: local_ckan:latest
    ports:
      - "5001:5000"
    depends_on:
      - postgresql
      - solr
    configs:
      - source: ckan_conf
        target: /etc/ckan/default/ckan.ini
    environment:
      - DK_CKAN_INI_PATH=/etc/ckan/default/ckan.ini
  postgresql:
    image: postgres:15.6
    ports:
      - "5432:5432"
    env_file:
      - postgresql/env_db
    configs:
      - source: postgres_conf
        target: /etc/postgresql/postgresql.conf
      - source: db_user_creation
        target: /docker-entrypoint-initdb.d/db_user_setup.sh
        mode: 0500
    command: ["postgres", "-c", "config_file=/etc/postgresql/postgresql.conf"]
  solr:
    image: local_solr:latest
    ports:
      - "8983:8983"
configs:
  ckan_conf:
    file: ./ckan/ckan.ini
  postgres_conf:
    file: ./postgresql/my-postgres.conf
  db_user_creation:
    file: ./postgresql/db_users_setup.sh
